<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¦³å…‰ãŠã™ã™ã‚ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="container">
    <h1>è¦³å…‰ãŠã™ã™ã‚ã‚·ã‚¹ãƒ†ãƒ </h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="messages">
          {% for category, message in messages %}
            <div class="message {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form action="{{ url_for('recommend') }}" method="post">
        <!-- ã‚«ãƒ†ã‚´ãƒª -->
        <fieldset>
            <legend>ã‚«ãƒ†ã‚´ãƒª</legend>
            <label>
                <input type="radio" name="category" value="restaurant" checked>
                é£²é£Ÿï¼ˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ / ã‚«ãƒ•ã‚§ï¼‰
            </label>
            <label>
                <input type="radio" name="category" value="place">
                è¦³å…‰ã‚¹ãƒãƒƒãƒˆ / æ–½è¨­
            </label>
        </fieldset>

        <!-- ğŸ” æ¤œç´¢æ–¹æ³• -->
        <fieldset>
            <legend>æ¤œç´¢æ–¹æ³•</legend>
            <label>
                <input type="radio" name="search_mode" value="station" checked>
                é§…åã§æ¤œç´¢
            </label>
            <label>
                <input type="radio" name="search_mode" value="map">
                åœ°å›³ã§æ¤œç´¢
            </label>
        </fieldset>

        <!-- é§…å -->
        <div class="form-group" id="station-group">
            <label>èµ·ç‚¹ã¨ãªã‚‹é§…</label>
            <input type="text" name="station" placeholder="ä¾‹ï¼‰åå¤å±‹é§…">
            <p class="note">é§…åã§æ¤œç´¢ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        </div>

        <!-- åœ°å›³ã§å ´æ‰€ã‚’æŒ‡å®š -->
        <div class="form-group" id="map-group" style="display:none;">
            <label>åœ°å›³ã§å ´æ‰€ã‚’æŒ‡å®š</label>
            <div id="map" style="height: 300px; border-radius: 8px; overflow: hidden;"></div>
            <input type="hidden" name="lat" id="lat-input">
            <input type="hidden" name="lng" id="lng-input">
            <p id="latlng-display" style="margin-top: 8px; font-size: 0.9rem; color: #555;">
                åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®åœ°ç‚¹ãŒèµ·ç‚¹ã«ãªã‚Šã¾ã™ã€‚
            </p>
        </div>

        <!-- ã‚¸ãƒ£ãƒ³ãƒ« & å„ªå…ˆåº¦ -->
        <div id="restaurant-options" class="category-options">
            <h3>é£²é£Ÿã‚¸ãƒ£ãƒ³ãƒ«</h3>
            <select name="genre">
                {% for key, label in restaurant_genres.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
            </select>

            <h3>å„ªå…ˆã—ãŸã„ãƒã‚¤ãƒ³ãƒˆ</h3>
            <select name="priority">
                {% for key, label in restaurant_priorities.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="place-options" class="category-options" style="display:none;">
            <h3>è¦³å…‰ã‚¸ãƒ£ãƒ³ãƒ«</h3>
            <select name="genre">
                {% for key, label in place_genres.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
            </select>

            <h3>å„ªå…ˆã—ãŸã„ãƒã‚¤ãƒ³ãƒˆ</h3>
            <select name="priority">
                {% for key, label in place_priorities.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <h3>æ¤œç´¢ç¯„å›²ï¼ˆåŠå¾„ï¼‰</h3>
        <select name="radius">
            <option value="500">500 m</option>
            <option value="1000" selected>1 km</option>
            <option value="2000">2 km</option>
            <option value="3000">3 km</option>
            <option value="5000">5 km</option>
        </select>


        <button type="submit">ãŠã™ã™ã‚ã‚’è¡¨ç¤º</button>
    </form>
</div>

<script>
    // ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆï¼ˆé£²é£Ÿ / è¦³å…‰ï¼‰
    const categoryRadios = document.querySelectorAll('input[name="category"]');
    const restOpts = document.getElementById('restaurant-options');
    const placeOpts = document.getElementById('place-options');

    function updateCategoryOptions() {
        const value = document.querySelector('input[name="category"]:checked').value;
        if (value === "restaurant") {
            restOpts.style.display = "block";
            placeOpts.style.display = "none";
        } else {
            restOpts.style.display = "none";
            placeOpts.style.display = "block";
        }
    }

    categoryRadios.forEach(r => r.addEventListener('change', updateCategoryOptions));
    updateCategoryOptions();

    // æ¤œç´¢æ–¹æ³•åˆ‡ã‚Šæ›¿ãˆï¼ˆé§…å / åœ°å›³ï¼‰
    const searchModeRadios = document.querySelectorAll('input[name="search_mode"]');
    const stationGroup = document.getElementById('station-group');
    const mapGroup = document.getElementById('map-group');

    let map;        // Google Map ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    let marker;     // ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã®ãƒãƒ¼ã‚«ãƒ¼
    const initialPos = { lat: 35.170915, lng: 136.881537 }; // åå¤å±‹é§…ã‚ãŸã‚Š

    function updateSearchMode() {
        const mode = document.querySelector('input[name="search_mode"]:checked').value;
        if (mode === "station") {
            stationGroup.style.display = "block";
            mapGroup.style.display = "none";
        } else {
            stationGroup.style.display = "none";
            mapGroup.style.display = "block";
            // åœ°å›³ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸå¾Œã«ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            if (map) {
                setTimeout(() => {
                    google.maps.event.trigger(map, "resize");
                    map.setCenter(initialPos);
                }, 0);
            }
        }
    }

    searchModeRadios.forEach(r => r.addEventListener('change', updateSearchMode));
    // initMap å†…ã§ã‚‚æœ€å¾Œã«å‘¼ã¶
</script>

<script>
    // Google Maps ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦å‘¼ã°ã‚Œã‚‹
    let latInput, lngInput, latlngDisplay;

    function initMap() {
        latInput = document.getElementById('lat-input');
        lngInput = document.getElementById('lng-input');
        latlngDisplay = document.getElementById('latlng-display');

        map = new google.maps.Map(document.getElementById("map"), {
            center: initialPos,
            zoom: 13,
        });

        map.addListener("click", (e) => {
            const lat = e.latLng.lat();
            const lng = e.latLng.lng();

            if (marker) {
                marker.setMap(null);
            }
            marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
            });

            latInput.value = lat;
            lngInput.value = lng;
            latlngDisplay.textContent =
                `é¸æŠä¸­ï¼šç·¯åº¦ ${lat.toFixed(5)}, çµŒåº¦ ${lng.toFixed(5)}`;
        });

        // åˆæœŸã®æ¤œç´¢æ–¹æ³•è¡¨ç¤ºã‚’åæ˜ 
        updateSearchMode();
    }
</script>

<!-- Google Maps JavaScript API èª­ã¿è¾¼ã¿ -->
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap"
  async defer
></script>

</body>
</html>
